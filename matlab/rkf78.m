% RK78外推算法
function xh = rkf78(dynfunc,h,x)
persistent ak b1 b2 b3 b4 b5 b6 b7 b8 b9 b10 b11 b12 W
if isempty(ak)
	ak = [ 2.0 / 27.0,		1.0 / 9.0,		1.0 / 6.0,		5.0 / 12.0,		1.0 / 2.0, ...
		   5.0 / 6.0,		1.0 / 6.0,		2.0 / 3.0,		1.0 / 3.0,		1.0,		0.0,		1.0 ];
	b1 = 2.0 / 27.0;
	b2 = [ 1.0/36.0, 1.0/12.0 ];
	b3 = [ 1.0/24.0, 0.0, 0.125 ];
	b4 = [ 5.0/12.0, 0.0, -1.5625, 1.5625 ];
	b5 = [ 0.05,	0.0, 0.0, 0.25, 0.2 ];
	b6 = [ -25.0/108.0, 0.0, 0.0, 125.0/108.0, -65.0/27.0, 125.0/54.0 ];
	b7 = [  31.0/300.0, 0.0, 0.0, 0.0, 61.0/225.0, -2.0/9.0, 13.0/900.0 ];
	b8 = [ 2.0, 0.0, 0.0, -53.0/6.0, 704.0/45.0, -107.0/9.0, 67.0/90.0, 3.0 ];
	b9 = [ -91.0/108.0, 0.0, 0.0, 23.0/108.0, -976.0/135.0, 311.0/54.0, -19.0/60.0, 17.0/6.0, -1.0/12.0 ];
	b10 = [ 2383.0/4100.0, 0.0, 0.0, -341.0/164.0, 4496.0/1025.0, -301.0/82.0, 2133.0/4100.0, 45.0/82.0, 45.0/164.0, 18.0/41.0 ];
	b11 = [ 3.0/205.0, 0.0, 0.0, 0.0, 0.0, -6.0/41.0, -3.0/205.0, -3.0/41.0, 3.0/41.0, 6.0/41.0, 0.0 ];
	b12 = [ -1777.0/4100.0, 0.0, 0.0, -341.0/164.0, 4496.0/1025.0, -289.0/82.0, 2193.0/4100.0, 51.0/82.0, 33.0/164.0, 12.0/41.0, 0.0, 1.0 ];
	W = [  0.0, 0.0, 0.0, 0.0, 34.0/105.0, 9.0/35.0, 9.0/35.0, 9.0/280.0, 9.0/280.0, 0.0, 41.0/840.0, 41.0/840.0 ];
end

x1 = x;
% t1 = t;
y0 = dynfunc(x1);

x1 = x + h*b1*y0;
% t1 = t + h*ak(1);
y1 = dynfunc(x1);

x1 = x + h*(b2(1)*y0 + b2(2)*y1);
% t1 = t + h*ak(2);
y2 = dynfunc(x1);

x1 = x + h*(b3(1)*y0 + b3(3)*y2);
% t1 = t + h*ak(3);
y3 = dynfunc(x1);

x1 = x + h*(b4(1)*y0 + b4(3)*y2 + b4(4)*y3);
% t1 = t + h*ak(4);
y4 = dynfunc(x1);

x1 = x + h*(b5(1)*y0 + b5(4)*y3 + b5(5)*y4);
% t1 = t + h*ak(5);
y5 = dynfunc(x1);

x1 = x + h*(b6(1)*y0 + b6(4)*y3 + b6(5)*y4 + b6(6)*y5);
% t1 = t + h*ak(6);
y6 = dynfunc(x1);

x1 = x + h*(b7(1)*y0 + b7(5)*y4 + b7(6)*y5 + b7(7)*y6);
% t1 = t + h*ak(7);
y7 = dynfunc(x1);

x1 = x + h*(b8(1)*y0 + b8(4)*y3 + b8(5)*y4 + b8(6)*y5 + b8(7)*y6 + b8(8)*y7);
% t1 = t + h*ak(8);
y8 = dynfunc(x1);

x1 = x + h*(b9(1)*y0 + b9(4)*y3 + b9(5)*y4 + b9(6)*y5 + b9(7)*y6 + b9(8)*y7 + b9(9)*y8);
% t1 = t + h*ak(9);
y9 = dynfunc(x1);

x1 = x + h*(b10(1)*y0 + b10(4)*y3 + b10(5)*y4 + b10(6)*y5 + b10(7)*y6 + b10(8)*y7 + b10(9)*y8 + b10(10)*y9);
% t1 = t + h;  % ak[10] = 1.0
y10 = dynfunc(x1);

x1 = x + h*(b11(1)*y0 + b11(6)*y5 + b11(7)*y6 + b11(8)*y7 + b11(9)*y8 + b11(10)*y9);
% t1 = t;     % ak[11] = 0.0
y11 = dynfunc(x1);

x1 = x + h*(b12(1)*y0 + b12(4)*y3 + b12(5)*y4 + b12(6)*y5 + b12(7)*y6 + b12(8)*y7 + b12(9)*y8 + b12(10)*y9 + b12(12)*y11);
% t1 = t + h;   % ak[12] = 1.0
y12 = dynfunc(x1);

xh = x + h*( W(5)*y5 + W(6)*y6 + W(7)*y7 + W(8)*y8 + W(9)*y9 + W(11)*y11 + W(12)*y12 );